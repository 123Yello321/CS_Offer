# 进程与线程

操作系统最核心的概念是进程，它是对正在运行的程序的一个抽象。一个进程就是一个正在执行程序的实例，包括程序计数器、寄存器和变量的当前值。

# 进程

从不同的角度，进程可以有不同的定义，比较典型的定义有：

* 进程是程序的一次执行过程。
* 进程是一个程序及其数据在处理机上顺序执行时所发生的活动。
* 进程是具有独立功能的程序在一个数据集合上运行的过程，它是系统进行资源分配和调度的一个独立单位。

系统利用`进程控制块`（Process Control Block, PCB）来描述进程的基本情况和运行状态，进而控制和管理进程。PCB是进程存在的唯一标志！

相应地，由程序段、相关数据段和PCB三部分构成了进程映像（进程实体）。所谓创建进程，实质上是创建进程映像中的PCB；而撤销进程，实质上是撤销进程的PCB。值得注意的是，进程映像是静态的，进程则是动态的。

## 进程状态转换

进程在其生命周期内，由于系统中各进程之间的相互制约关系及系统的运行环境的变化，使得进程的状态也在不断地发生变化（一个进程会经历若干种不同状态）。通常进程有以下五种状态，前三种是进程的基本状态。

1. 运行状态：进程正在 CPU 上运行。在单处理机环境下，每一时刻最多只有一个进程处于运行状态。
2. 就绪状态：进程已处于准备运行的状态，即进程获得了除 CPU 之外的一切所需资源，一旦得到 CPU 即可运行。
3. 阻塞状态，又称等待状态：进程正在等待某一事件而暂停运行，如等待某资源为可用（不包括CPU）或等待输入/输出完成。即使CPU空闲，该进程也不能运行。
4. 创建状态：进程正在被创建，尚未转到就绪状态。创建进程通常需要多个步骤：首先申请一个空白的PCB，并向PCB中填写一些控制和管理进程的信息；然后由系统为该进程分配运行时所必需的资源；最后把该进程转入到就绪状态。
5. 结束状态：进程正从系统中消失，这可能是进程正常结束或其他原因中断退出运行。当进程需要结束运行时，系统首先必须置该进程为结束状态，然后再进一步处理资源释放和回收等工作。

下图说明了进程间状态转换的过程：

![][1]


## 进程调度



## 进程间通信（IPC）

Linux 下进程通信有如下的目的：

1. 数据传输，一个进程需要将它的数据发送给另一个进程，发送的数据量在一个字节到几M之间；
2. 共享数据，多个进程想要操作共享数据，一个进程对数据的修改，其他进程应该立刻看到；
3. 通知事件，一个进程需要向另一个或一组进程发送消息，通知它们发生了某件事情；
4. 资源共享，多个进程之间共享同样的资源。为了做到这一点，需要内核提供锁和同步机制；
5. 进程控制，有些进程希望完全控制另一个进程的执行（如Debug进程），此时控制进程希望能够拦截另一个进程的所有陷入和异常，并能够及时知道它的状态改变。

系统进行进程间通信（IPC）的时候，可用的方式包括`管道、命名管道、消息队列、信号量、共享内存、套接字(socket)`等形式。

### 管道

### 命名管道

### 消息队列


Linux中，与IPC相关的命令包括：ipcs、ipcrm（释放IPC）。IPCS命令是Linux下显示进程间通信设施状态的工具。

* ipcs -m: 输出有关共享内存(shared memory)的信息
* ipcs -q: 输出有关信息队列(message queue)的信息


## 信号量

## 共享内存

## 套接字


# 线程

## 进程共享

线程共享的内容包括：

* 进程 代码段
* 进程 数据段
* 进程打开的文件描述符、
* 信号的处理器
* 进程的当前目录
* 进程用户 ID 与进程组 ID    

线程独有的内容包括：

* 线程 ID
* `寄存器`组的值
* 线程的堆栈
* 错误返回码
* 线程的信号屏蔽码

## 线程间通信

互斥量（mutex），信号量，条件变量

# 进程与线程

下面主要从调度、并发性、系统开销、拥有资源等方面来对线程与进程进行比较。

1. `调度`：线程作为调度和分配的基本单位，进程作为拥有资源的基本单位。
2. `并发性`：在引入线程的操作系统中，不仅进程之间可以并发执行，而且在一个进程中的多个线程之间也可以并发执行，使得操作系统具有更好的并发性，从而能更加有效地使用系统资源和提高系统的吞吐量。  
3. `拥有资源`：进程是拥有资源的基本单位，一般地说，线程自己不拥有系统资源（也有一点必不可少的资源），但它可以访问其隶属进程的资源，即一个进程的代码段、数据段及所拥有的系统资源（如已打开的文件、I/O设备等），可供该进程中的所有线程所共享。
4. `系统开销`：在创建或撤销进程时，系统都要为之分配和回收进程控制块、内存空间、I/O设备等，因此操作系统所付出的开销显著地大于创建或撤销线程时的开销。
5. `上下文切换`：在进行进程切换时，涉及到当前进程CPU环境的保存及新被调度运行进程CPU环境的设置。而线程的切换只需要保存和设置少量寄存器地内容，不涉及存储器管理方面的操作。可见，进程切换的开销也远大于线程切换的开销。
6. `数据共享`：由于同一个进程中的多个线程具有相同的地址空间，在同步和通信的实现方面线程也比进程容易。在一些操作系统中，线程的切换、同步和通信都无须操作系统内核的干预。
  

多线程和多进程的区别（重点 面试官最最关心的一个问题，必须从cpu调度，上下文切换，数据共享，多核cup利用率，资源占用，等等各方面回答）

# 参考

《UNIX 环境高级编程》  
[进程与线程的一个简单解释](http://www.ruanyifeng.com/blog/2013/04/processes_and_threads.html)  
[Linux的IPC命令](http://www.cnblogs.com/cocowool/archive/2012/05/22/2513027.html)  
[操作系统(计算机)进程和线程管理](http://c.biancheng.net/cpp/u/xitong_2/)  

